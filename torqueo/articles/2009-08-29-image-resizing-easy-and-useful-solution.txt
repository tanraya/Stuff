title: "Ресайзинг изображений на сайте. Как сделать это удобно?"
tags:
- htaccess
- mod_rewrite
- thumbnail

<body>
<p>Когда на сайте используется изображение в различных размерах, например,  когда обложка музыкального диска должна отображаться в нескольких размерах, многие разработчики чего только выдумывают, чтобы реализовать эту функциональность. Например, после закачки картинки, делается несколько копий картинки и кладется на диск. Некоторые вообще везде используют оригинальную картинку, а когда нужно, "меняют" ее размер, выставляя нужную высоту и ширину в теге <em>img </em>- такое встречается повсеместно (за такое решение нужно кое-что отрывать).

Я расскажу, как сделать ресайзинг картинок по-запросу. Впервые, я использовал это решение в 2004 году в одном из проектов, над которым я работал. Идея проста до безобразия.
~

Давайте представим, что у вас есть оригинальное изображение, размером <em>1000х1000</em> пикселей. Вам нужно использовать уменьшенные копии этого изображения в различных местах сайта в размерах <em>300х300, 200х200</em> и <em>50х50</em> пикселей.

Вы закачиваете оригинальное изображение на сайт через форму и оно распологается здесь, от document_root:
</p>
<pre>/pictures/777.jpg</pre>
Теперь, на одной из страниц сайта, вы хотите показать это изображение, но в размере <em>200х200</em> пикселей, и вы вставляете на странице тег:
<pre>&lt;img src="/pictures/200x200/777.jpg" /&gt;</pre>
и - вуаля - картинка в нужном вам размере отображается на странице! Как это сделано? Довольно просто. Нам всего лишь нужно перехватить все обращения веб-сервера к несуществующим картинкам. Для этого напишем правило в<em> .htaccess</em> и положим его в <em>document_root</em>:
<div class="gist-wrapper"><script src="https://gist.github.com/1768705.js?file=gistfile1."></script></div>
Теперь все обращения к несуществующим картинкам в папке <em>/pictures</em> будут передаваться в скрипт <em>resize.php</em>, расположенный в корне. В скрипт будет передаваться путь к несуществующей картинке относительно<em> document_root</em>.

Скрипт приводить я не буду - оставлю реализацию вам. Я только укажу, что необходимо предусмотреть в скрипте.
<ul>
<li>Определить путь к оригинальному изображению.</li>
	<li>Нужно проверить существование оригинального изображения. Если оно не существует, вернуть 404-ю ошибку.</li>
	<li>Нужно получить из пути к запрашиваемой картинки требуемую ширину и высоту.</li>
	<li>Если оригинальное изображение существует и существует запрашиваемая директория (например<em> /pictures/200x200</em> - это даст защиту от указания произвольных размеров картинки), то изменяем размер картинки при помощи <a href="http://www.imagemagick.org/script/convert.php" rel="nofollow,noindex">ImageMagick</a> или <a href="http://ru.php.net/manual/en/book.image.php" rel="nofollow,noindex">GD</a> и сохраняем картинку по запрашиваемому пути. Затем делаем на внось созданную картинку внутренний редирект (например, Location: <em>/pictures/200x200/777.jpg</em>).</li>
</ul>
После реализации подобного скрипта наша система ресайзинга картинок готова. Скрипт будет изменять размер картинки только один раз. Если запрашиваемая заресайзенная картинка уже существует, то скрипт изменения размера даже не будет запускаться - правило в .htaccess не сработает, всю работу выполнит веб-сервер.

Я знаю, что подобное решение использую не я один =). Но надеюсь, моя заметка поможет тем, кто не знал о подобном решении.</body>
